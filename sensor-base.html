<link rel="import" href="../polymer/polymer.html">

<script>
	window.DiyaBehaviors = window.DiyaBehaviors || {};
  DiyaBehaviors.SensorBase = {
	  properties: {
		  label: { notify: true },
		  name: { notify: true },
		  period: {
			  type: Number,
			  value: 30000,
			  notify: true
		  },
		  selector: { notify: true },
		  value: { notify: true },
		  min: { notify: true },
		  max: { notify: true },
		  resolution: {
			  type: Number,
			  value: 1,
			  notify: true
		  },
		  precision: {
			  type: Number,
			  value: 0,
			  notify: true
		  }
	  },
	  ready: function () {
		  this.autoRefresh();
	  },
	  icon: function () {
	  },
	  autoRefresh: function () {
		  var that = this;
		  if (this.selector) {
			  //request last value for the specified sensor
			  d1(this.selector).IEQ().updateData(function (model) {
				  //console.log('sensorBase');
				  //console.log(model);
				  that.updateModel(model);
			  }, { // Config data request
				  criteria: {
					  time: {
						  range: 15
					  }
				  },
				  sampling: 1,
				  operator: 'avg',
				  sensors: [that.name]
			  });
		  }
		  //request again in the specified period
		  setTimeout(this.autoRefresh.bind(this), parseInt(this.period));
	  },
	  updateModel: function (model) {
		  if (!model)
			  return;
		  var data = model[this.name];
		  if (!data || !Array.isArray(data.data) || isNaN(data.data[0]) || !data.qualityConfig || !Array.isArray(data.range) || isNaN(data.range[0]) || isNaN(data.range[1])) {
			  return;
		  }
		  if (!isNaN(data.qualityConfig.indexRange)) {
			  this.quality = data.qualityIndex[0];
		  }
		  this.unit = data.unit;
		  this.min = data.range[0];
		  this.max = data.range[1];
		  var val = data.data[0];;
		  if(this.resolution>0)
			  val = Math.round(val/this.resolution)*this.resolution;
		  this.value = val.toFixed(this.precision);
//		  this.value = val.toString();
	  }
  };
</script>


<dom-module id="sensor-base">
  <template>
	</template>
</dom-module>
<script>
	Polymer({
		is: 'sensor-base',
		behaviors:[DiyaBehaviors.SensorBase]
	});
</script>
